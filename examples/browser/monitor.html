<!DOCTYPE html>
<html>
<head>
  <title>Pryv Javascript Lib | Monitor</title>
  <script src="../../dist/pryv.js"></script>

</head>
<body>


  <input type='button' value='add Event' onClick='addEventClicked()'>
  <input type='text' id='addContent' value='someText'>

<h1>Events Live</h1>
<textarea id='events' rows=20 cols=100></textarea>

<script type='text/javascript'>
  // selectors
  var $events = document.getElementById('events');
  var $addContent = document.getElementById('addContent');

  function logEventChange(action, event) {
    var line = action + ' '+ event.time + ' ' + event.type + ' ' + JSON.stringify(event.content).substring(0,80);
    $events.value += line + '\n';
    $events.scrollTop = $events.scrollHeight;
  }

  // load Pryv
  var Pryv = require('pryv');
  // .useStaging() only when debug / dev
  var api = (new Pryv.Connection('perkikiki', 'TTZycvBTiq')).useStaging();


  var filter = new Pryv.Filter();
  var monitor = api.monitor(filter);

  function onLoad(events) {
    console.log('monitor loaded');
    for (var i = 0; i < events.length; i++) {
      logEventChange('+', events[i]);
    }
  }
  monitor.addEventListener(Pryv.Messages.Monitor.ON_LOAD, onLoad);


  function onEventChange(changes) {
    _.each({change: '~', remove: '-', add: '+'}, function (key, actionStr) {
      for (var i = 0; i < changes[key].length; i++) {
        logEventChange(actionStr, events[key][i]);
      }
    });
  }
  monitor.addEventListener(Pryv.Messages.Monitor.ON_EVENT_CHANGE, onEventChange);



  monitor.start();

  function createNoteEvent(content) {
    var eventData = {streamId : 'test', type: 'note/txt', content: content};
    api.events.create(eventData, function () {
      console.log('event created');
    });
  }

  function addEventClicked() { // from the web page
    createNoteEvent(addContent.value);
  }

</script>
</body>
</html>